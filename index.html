<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>AXIS</title>

<!-- PWA -->
<link rel="manifest" href="manifest.json">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black">
<meta name="apple-mobile-web-app-title" content="AXIS">
<link rel="apple-touch-icon" href="icon512.png">

<link rel="stylesheet" href="styles.css">

<script>
// Registra SW se existir
if (location.protocol === "https:" || location.protocol === "http:") {
  if ("serviceWorker" in navigator) {
    navigator.serviceWorker.register("sw.js")
      .then(() => console.log("SW registrado"))
      .catch(err => console.log("Erro SW:", err));
  }
}
</script>

</head>
<body class="training">

<!-- ================= LICENÇA (RODA ANTES DE TUDO) ================= -->
<script>
(async function () {
  const STORAGE_KEY = "axis_license_code_v1";

  // Detecta se está rodando como PWA
  const isPWA =
      window.navigator.standalone === true ||
      window.matchMedia("(display-mode: standalone)").matches;

  let license = localStorage.getItem(STORAGE_KEY);

  // Safari → salva licença vinda da URL
  if (!isPWA && !license) {
    const params = new URLSearchParams(location.search);
    const urlLicense = params.get("license");

    if (urlLicense) {
      console.log("Salvar via Safari:", urlLicense);
      localStorage.setItem(STORAGE_KEY, urlLicense);
      license = urlLicense;
    }
  }

  // PWA → usa APENAS localStorage
  // (não existe parâmetro na URL no PWA)
  if (isPWA) {
    console.log("Rodando no PWA. Licença encontrada:", license);
  }

  // Se não houver licença → bloqueia
  if (!license) {
    document.body.innerHTML = `
    <div style="padding:40px;font-family:-apple-system;text-align:center;color:white;background:black;">
      <h1>AXIS – Licença necessária</h1>
      <p>Abra no Safari usando ?license=XXXX antes de instalar o app.</p>
    </div>`;
    return;
  }

  // Validação no Worker
  try {
    const res = await fetch(
      "https://axislicense.d2bz92x2cp.workers.dev/check?key=" + license,
      { cache: "no-cache" }
    );
    const data = await res.json();

    if (!data.valid) {
      document.body.innerHTML = `
      <div style="padding:40px;font-family:-apple-system;text-align:center;color:white;background:black;">
        <h1>AXIS – Acesso negado</h1>
        <p>Licença inválida.</p>
      </div>`;
      return;
    }

    console.log("LICENÇA OK (Safari/PWA):", data);

  } catch (e) {
    document.body.innerHTML = `
    <div style="padding:40px;font-family:-apple-system;text-align:center;color:white;background:black;">
      <h1>Erro ao validar licença</h1>
      <p>Verifique sua conexão.</p>
    </div>`;
    return;
  }
})();
</script>

<!-- ============================= SUA INTERFACE ============================= -->
<div id="home" class="panel center visible">
  <div id="home-step1">
    <div class="mode-title">AXIS</div>
    <div class="label">Modo de Uso</div>
    <button class="btn" onclick="setModePerformance()">Performance Mode</button>
    <button class="btn" onclick="setModeTraining()">Training Mode</button>
  </div>

  <div id="home-step2" style="display:none;">
    <div class="mode-title">Selecione o Modo</div>
    <button class="btn" onclick="startSwipe()">Swipe Mode</button>
    <button class="btn" onclick="startPigback()">Pigbacking</button>
    <button class="btn" onclick="startGrade()">Grade Mode</button>
    <button class="btn" onclick="startLexicon()">Lexicon</button>
    <button class="btn small" onclick="goHome(true)">Voltar</button>
  </div>
</div>

<!-- TODO O RESTO DO SEU HTML AQUI (idêntico ao anterior)... -->

<script src="script_v2.js"></script>
<div id="hud"></div>

</body>
</html>
